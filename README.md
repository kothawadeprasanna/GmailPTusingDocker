
#  Gmail API testing using Jmeter

Hi :wave:
Here, we will create Jmeter script for gmail API and create a docker image for the same. We will also use that to execute and generate report.



## API Reference

[API details](https://developers.google.com/gmail/api/reference/rest/v1/users.drafts/list)

###  users.drafts.list 
Lists the drafts in the user's mailbox.
```http
  GET https://gmail.googleapis.com/gmail/v1/users/{userId}/drafts
```

| Parameter | Type     | Description                |
| :-------- | :------- | :------------------------- |
| `userId` | `string` | **Required**. Gmail address|


| Header Parameter | Type     | Description                |
| :-------- | :------- | :------------------------- |
| `Authorization` | `string` |Bearer Access token generated by OAuth|

This API requires Requires one of the following OAuth scopes:
* https://mail.google.com/
* https://www.googleapis.com/auth/gmail.modify
* https://www.googleapis.com/auth/gmail.compose
* https://www.googleapis.com/auth/gmail.readonly

### OAuth2 Token generation
To access the above API, user needs to pass the access token. This token is valid for 3599 sec. So, user needs to generate that every hour. 

Follow this page to setup and create access token:
* [Using OAuth 2.0 to Access Google APIs](https://developers.google.com/identity/protocols/oauth2)

Below is the short summary to setup OAuth2: 
  1. Obtain OAuth 2. 0 credentials from the Google API Console. ...
  2. Obtain an access token from the Google Authorization Server. ...
  3. Examine scopes of access granted by the user. ...
  4. Send the access token to an API. ...
  5. Generate Refresh access token.
  
  As refresh token can be used for longer duration upto 6 months. We will use that to generate the Access token. 
  
## Software Installations

To run this user needs below softwares to be installed
* [JAVA](https://positive-stud.medium.com/step-by-step-guide-to-install-java-on-windows-pc-c85e7778c14c) 
* [JMETER](https://www.guru99.com/guide-to-install-jmeter.html)

Or 

* Use docker image containing required script and testdata.  

 [DOCKER IMAGE](https://hub.docker.com/r/pkothawade/jmeterforgmail)

```bash
  docker pull pkothawade/jmeterforgmail
```

## Script Description


<details>
  <summary>Script description!</summary>
  
  ### Script contains two thread groups :
  1. "Thread group: Positive" for positive scenario where http: 200 response code is expected.
  2. "Thread group: Negative" for negative scenario where older token is passed to get the http: 401 response code.
  
  ### List of variables :
  * BASE_URL_1: Domain. This property can be modified from outside
  * TestDataFile1: CSV test data file name . This property can be modified from outside.
	* tokenexpirytime: Time duration after which new access token will be generated. This property can be modified from outside. Max value is 3599 sec. 
  * isexpired: Based on this flag, access token generation request is controlled.
</details>
    
<details>    
  <summary>Script Logic</summary>
  
  In positive test scenario we require Access token to test the gmail /users/draft API.
  <br></br>
  #Access Token generation logic#: Based on the "isexpired" flag this request is controlled. Default value is set to "true", so that in the first iteration of each thread it gets 
called. When fresh "Access Token" is generated, this flag is set to false in postprocessor and token generation time is stored in variable. As a response to access token generation 
request, dynamic access token is captured and passed to next request. 
  <br></br>  
    After /users/draft API, age of the token is calculated, if it is less than the "tokenexpirytime", "isexpired" flag is set to be "false". So, that in the next iteration access 
token generation request does not get called. If age of the token is more than the "tokenexpirytime", "isexpired" flag is set to be "true". So, that in the next iteration access 
token generation request does get called. So, after every API called, token age is calculated and based on the tokenexpirytime set- fresh token is generated. 
</details>


## Execution
### Running Tests in machine using raw .jmx file

To run tests, run the following command

Execute below command to run the test. Modify commnad as per your requirement.
```bash
  jmeter -n -t GmailAPI.jmx -JMaxUsers=5 -JRampUp=5 -JNMaxUsers=5 -JNRampUp=5
   -Jduration=300 -JTestDataFile1='userId.csv'  -l Gmail-5-results.jtl -j jmeter.log -e -o HtmlReport
```
Below properties can be passed externally:
1. MaxUsers: Postive scenario max thread number
2. RampUp: Postive scenario Ramp up time
3. duration: Overall test duration
4. NMaxUsers: Negative scenario max thread number
5. NRampUp: Negative scenario Ramp up time
6. TestDataFile1 : CSV file containing - userId,client_id,client_secret,refresh_token 


One can modify startTest.bat present in git to start test in single click. (This requires all the parameters set correctly in the .bat file)

### Running Tests in Docker

To run tests, run the following command

```bash
docker run pkothawade/jmeterforgmail -n -t GmailAPI.jmx -JMaxUsers=5 -JRampUp=5 -JNMaxUsers=5 -JNRampUp=5 -Jduration=30
 -JTestDataFile1='userId.csv'  -l Gmail-5-results.jtl -j jmeter.log -e -o HtmlReport
```

## Analyse results:

*EXECUTE TEST:*
```bash
  docker run pkothawade/jmeterforgmail -n -t GmailAPI.jmx -JMaxUsers=5 -JRampUp=5 -JNMaxUsers=5 -JNRampUp=5 -Jduration=30
   -JTestDataFile1='userId.csv'  -l Gmail-5-results.jtl -j jmeter.log -e -o HtmlReport
```
*ANALYSE RESULT:*
```bash
  Get the docker container id :
  docker ps -a
```  
  get the container id as first coloum and replace that with da25032fa395 in below command
```bash
  docker cp da25032fa395:/opt/apache-jmeter-5.3/Gmail-5-results.jtl .
  OPEN DOWNLOADED .JTL FILE IN VIEWRESULTTREE/AGGREGATESUMAMRY OR YOUR FAVOURITE LISTENER.
  
  docker cp da25032fa395:/opt/apache-jmeter-5.3/HtmlReport .
  OPEN DOWNLOADED HTML REPORT IN ANY BROWSER. 
```
  
  
## Documentation

[API reference](https://developers.google.com/gmail/api/reference/rest/v1/users.drafts/list)
[Jmeter Installation guide](https://www.blazemeter.com/blog/how-get-started-jmeter-installation-test-plans/)
[Docker installation](https://docs.docker.com/engine/install/)
[Docker commands](https://www.docker.com/sites/default/files/d8/2019-09/docker-cheat-sheet.pdf)
  
## Author

- [@Prasanna Kothawade](https://github.com/kothawadeprasanna)  
